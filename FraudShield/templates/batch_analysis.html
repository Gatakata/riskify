{% extends "base.html" %}

{% block title %}Batch Analysis - FraudGuard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-6 fw-bold text-primary mb-3">Batch Transaction Analysis</h1>
            <p class="lead text-muted">Upload a CSV file to analyze multiple transactions at once</p>
        </div>

        <!-- Upload Form -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Upload CSV File
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label fw-semibold">Select CSV File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Upload a CSV file with transaction data for batch processing
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-cogs me-2"></i>
                            Process Transactions
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CSV Format Instructions -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-csv me-2"></i>
                    CSV Format Requirements
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Your CSV file should include the following columns:</p>
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Column Name</th>
                                <th>Description</th>
                                <th>Example</th>
                                <th>Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>amount</code></td>
                                <td>Transaction amount</td>
                                <td>250.75</td>
                                <td><span class="badge bg-success">Yes</span></td>
                            </tr>
                            <tr>
                                <td><code>merchant_category</code></td>
                                <td>Type of merchant</td>
                                <td>grocery, restaurant, online</td>
                                <td><span class="badge bg-success">Yes</span></td>
                            </tr>
                            <tr>
                                <td><code>hour</code></td>
                                <td>Transaction hour (0-23)</td>
                                <td>14</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>day</code></td>
                                <td>Day of week (1-7)</td>
                                <td>3</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>customer_age</code></td>
                                <td>Customer age</td>
                                <td>35</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>account_age_days</code></td>
                                <td>Account age in days</td>
                                <td>365</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>failed_attempts</code></td>
                                <td>Previous failed attempts</td>
                                <td>0</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>merchant_risk_score</code></td>
                                <td>Merchant risk (0.0-1.0)</td>
                                <td>0.1</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>frequency_24h</code></td>
                                <td>24h transaction frequency</td>
                                <td>2</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>avg_amount_30d</code></td>
                                <td>30-day average amount</td>
                                <td>125.50</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>location_risk_score</code></td>
                                <td>Location risk (0.0-1.0)</td>
                                <td>0.05</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>device_risk_score</code></td>
                                <td>Device risk (0.0-1.0)</td>
                                <td>0.02</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Optional columns will use default values if not provided. Only <code>amount</code> and <code>merchant_category</code> are required.
                </div>
            </div>
        </div>

        <!-- Sample CSV Download -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>
                    Sample Data
                </h5>
            </div>
            <div class="card-body">
                <p>Download a sample CSV file to see the correct format:</p>
                
                <div class="d-grid">
                    <button class="btn btn-outline-primary" onclick="downloadSampleCSV()">
                        <i class="fas fa-file-download me-2"></i>
                        Download Sample CSV
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        The sample file contains 5 example transactions with various risk profiles.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function downloadSampleCSV() {
    const csvContent = `amount,merchant_category,hour,day,customer_age,account_age_days,failed_attempts,merchant_risk_score,frequency_24h,avg_amount_30d,location_risk_score,device_risk_score
250.75,grocery,14,3,35,365,0,0.1,2,125.50,0.05,0.02
8500.00,online,2,7,28,90,3,0.8,15,200.00,0.7,0.6
45.20,restaurant,18,5,42,1200,0,0.2,1,85.30,0.1,0.03
1200.00,retail,12,2,31,500,1,0.3,4,300.00,0.2,0.1
75.50,gas_station,8,1,55,2500,0,0.1,1,95.20,0.05,0.02`;

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_transactions.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file');
    const form = document.querySelector('form');
    
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file.');
                this.value = '';
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('File size must be less than 10MB.');
                this.value = '';
                return;
            }
        }
    });
    
    form.addEventListener('submit', function() {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    });
});
</script>
{% endblock %}