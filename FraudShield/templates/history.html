{% extends "base.html" %}

{% block title %}Transaction History - FraudGuard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6 fw-bold text-primary">Transaction History</h1>
            <div>
                <a href="{{ url_for('export_csv') }}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-download me-2"></i>Export CSV
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                    <i class="fas fa-chart-bar me-2"></i>Dashboard
                </a>
            </div>
        </div>

        {% if transactions %}
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        All Transactions ({{ transactions|length }})
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Timestamp</th>
                                    <th>Amount</th>
                                    <th>Merchant</th>
                                    <th>Customer Age</th>
                                    <th>Fraud Risk</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                    <th>Risk Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                    <tr class="{% if transaction.is_fraud %}table-danger{% elif transaction.risk_level == 'high' %}table-warning{% endif %}">
                                        <td>
                                            <a href="{{ url_for('transaction_detail', transaction_id=transaction.id) }}" 
                                               class="text-decoration-none fw-bold">
                                                #{{ transaction.id }}
                                            </a>
                                        </td>
                                        <td>
                                            <small>{{ transaction.timestamp[:16].replace('T', ' ') }}</small>
                                        </td>
                                        <td>
                                            <strong>${{ "{:,.2f}".format(transaction.amount) }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ transaction.merchant_category|title }}</span>
                                        </td>
                                        <td>{{ transaction.customer_age }} years</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 12px;">
                                                    <div class="progress-bar bg-{% if transaction.fraud_probability > 0.7 %}danger{% elif transaction.fraud_probability > 0.3 %}warning{% else %}success{% endif %}" 
                                                         style="width: {{ (transaction.fraud_probability * 100)|round(1) }}%"></div>
                                                </div>
                                                <small>{{ (transaction.fraud_probability * 100)|round(1) }}%</small>
                                            </div>
                                        </td>
                                        <td>
                                            <small>{{ (transaction.confidence * 100)|round(1) }}%</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if transaction.status == 'approved' %}success{% elif transaction.status == 'declined' %}danger{% else %}warning{% endif %}">
                                                {{ transaction.status|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if transaction.risk_level == 'critical' %}danger{% elif transaction.risk_level == 'high' %}warning{% elif transaction.risk_level == 'medium' %}info{% else %}success{% endif %}">
                                                {{ transaction.risk_level|upper }}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('transaction_detail', transaction_id=transaction.id) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-light border-0">
                        <div class="card-body text-center">
                            <h4 class="text-primary">{{ transactions|length }}</h4>
                            <small class="text-muted">Total Transactions</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light border-0">
                        <div class="card-body text-center">
                            <h4 class="text-danger">{{ transactions|selectattr("is_fraud")|list|length }}</h4>
                            <small class="text-muted">Fraud Detected</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light border-0">
                        <div class="card-body text-center">
                            <h4 class="text-warning">{{ transactions|selectattr("risk_level", "equalto", "high")|list|length + transactions|selectattr("risk_level", "equalto", "critical")|list|length }}</h4>
                            <small class="text-muted">High Risk</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light border-0">
                        <div class="card-body text-center">
                            <h4 class="text-success">${{ "{:,.2f}".format(transactions|sum(attribute='amount')) }}</h4>
                            <small class="text-muted">Total Amount</small>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-5">
                    <i class="fas fa-history fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted mb-3">No Transaction History</h4>
                    <p class="text-muted mb-4">You haven't analyzed any transactions yet. Start by analyzing your first transaction to see it appear here.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Analyze First Transaction
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add search functionality
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control mb-3';
    searchInput.placeholder = 'Search transactions...';
    
    const cardHeader = document.querySelector('.card-header');
    if (cardHeader) {
        cardHeader.appendChild(searchInput);
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
    
    // Add tooltips to progress bars
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.title = `Fraud Risk: ${width}`;
    });
    
    // Row click functionality
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function(e) {
            if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                const link = this.querySelector('a[href*="transaction"]');
                if (link) {
                    window.location.href = link.href;
                }
            }
        });
    });
});
</script>
{% endblock %}